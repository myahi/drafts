pipeline {
  agent any

  stages {

    stage('Generate CDC CSV + Copy artifacts') {
      steps {
        script {
          // ---- Inputs Jenkins (GUI) ----
          String cdc = (params.CDC ?: "").trim()
          if (!cdc) error("CDC est vide")

          // ğŸ‘‰ adapte le nom du paramÃ¨tre qui contient ton JSON
          String raw = (params.COMPONENT_DATA ?: "").trim()
          if (!raw) error("JSON de sÃ©lection vide (params.COMPONENT_DATA)")

          echo "CDC=${cdc}"
          echo "RAW_JSON=${raw}"

          // ---- Parse JSON ----
          String jsonText = raw
          if (jsonText.startsWith("[{\\\"")) {
            jsonText = jsonText.replace("\\\"", "\"")
          }

          def selected
          try {
            selected = new groovy.json.JsonSlurperClassic().parseText(jsonText)
          } catch (Exception e) {
            error("Impossible de parser le JSON. Texte reÃ§u: ${jsonText}\nErreur: ${e.message}")
          }

          if (!(selected instanceof List) || selected.isEmpty()) {
            error("JSON parsÃ© mais liste vide / format invalide: ${selected?.getClass()?.name}")
          }

          // ---- Base dirs ----
          String baseDir = "/eai/livraison/CDC_${cdc}"
          sh "mkdir -p '${baseDir}'"

          // Repo Maven fixe (LINUX)
          String mavenRoot = "/eai/maven_eai_conf/.m2/repository/fr/labanquepostale/marches/eai"

          // ---- CSV header ----
          String header = "source_vm_name;source_os_type;source_file;target_vm_name;target_os_type;username;target_path;unzip_copied_file;archive_existed_file\n"
          StringBuilder csv = new StringBuilder(header)

          // ---- For each element: copy files + append 2 lines ----
          selected.each { item ->
            String artifact = (item.artifact ?: "").toString().trim()
            String version  = (item.version  ?: "").toString().trim()
            if (!artifact || !version) {
              error("EntrÃ©e JSON invalide (artifact/version manquant): ${item}")
            }

            // Source Maven dir for this artifact/version
            String srcDir = "${mavenRoot}/${artifact}/${version}"

            // Destination dir for CDC
            String destDir = "${baseDir}/${artifact}"
            sh "mkdir -p '${destDir}'"

            // Files to copy (same naming convention as your CSV)
            String tarName = "${artifact}-${version}-ear.tare"
            String pomName = "${artifact}-${version}.pom"

            // Copy with checks (fail fast if missing)
            sh """
              set -euo pipefail
              echo "[COPY] ${artifact}:${version}"
              echo "  from: ${srcDir}"
              echo "  to  : ${destDir}"

              test -f '${srcDir}/${tarName}' || { echo "âŒ Missing: ${srcDir}/${tarName}"; exit 2; }
              test -f '${srcDir}/${pomName}' || { echo "âŒ Missing: ${srcDir}/${pomName}"; exit 2; }

              cp -f '${srcDir}/${tarName}' '${destDir}/'
              cp -f '${srcDir}/${pomName}' '${destDir}/'
            """

            // ---- CSV lines ----
            String sourceDir  = "${baseDir}/${artifact}"
            String targetPath = "D:\\Serveur_apps\\tools\\repo_maven\\fr\\labanquepostale\\marches\\eai\\${artifact}\\${version}"

            // 1) ear.tare
            csv.append([
              "sgl4shn04",
              "LINUX",
              "${sourceDir}/${tarName}",
              "SPR1EMS01",
              "WINDOWS",
              "usr_svc_eai_qlf",
              targetPath,
              "true",
              "false"
            ].join(";")).append("\n")

            // 2) pom
            csv.append([
              "sgl4shn04",
              "LINUX",
              "${sourceDir}/${pomName}",
              "SPR1EMS01",
              "WINDOWS",
              "usr_svc_eai_qlf",
              targetPath,
              "true",
              "false"
            ].join(";")).append("\n")
          }

          // ---- Write file (overwrite) ----
          String outFile = "${baseDir}/conf.csv"
          writeFile file: outFile, text: csv.toString(), encoding: "UTF-8"

          echo "CSV gÃ©nÃ©rÃ© : ${outFile}"
          echo "Composants : ${selected.size()} => fichiers copiÃ©s: ${selected.size() * 2} (pom+tar) / lignes CSV: ${selected.size() * 2} + entÃªte"
        }
      }
    }

  }
}
