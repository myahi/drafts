<script>
(function(){
  window.updateComponentData = function() {
    var lines = [];
    var cbs = document.querySelectorAll('input.ac-enabled');
    
    cbs.forEach(function(cb) {
      if (!cb.checked) return;
      var i = cb.name.match(/line_(\\d+)_enabled/)[1];
      var art = document.querySelector('input[name="line_' + i + '_key"]').value;
      var ver = document.querySelector('select[name="line_' + i + '_version"]').value;
      if (art && ver) lines.push(art + '=' + ver);
    });
    
    // ✅ Écriture dans VOTRE champ caché - C'EST TOUT !
    document.getElementById('COMPONENT_DATA').value = lines.join('\\n');
  };
  
  // Init
  setTimeout(window.updateComponentData, 100);
})();
</script>

pipeline {
    agent any
    stages {
        stage('Récupérer COMPONENT_DATA') {
            steps {
                script {
                    // Récupère la valeur depuis la requête HTTP
                    def componentData = currentBuild.rawBuild.getAction(hudson.model.ParametersAction)?.getParameter('COMPONENT_DATA')?.value
                    
                    if (componentData) {
                        env.COMPONENT_DATA = componentData
                    } else {
                        env.COMPONENT_DATA = ''
                    }
                    
                    echo "COMPONENT_DATA = ${env.COMPONENT_DATA}"
                }
            }
        }
        stage('Utilisation shell') {
            steps {
                sh '''
                    echo "$COMPONENT_DATA"
                    echo "$COMPONENT_DATA" > components.txt
                '''
            }
        }
    }
}


<script>
(function(){
  function setStatus(txt) {
    var s = document.getElementById('js_status');
    if (s) s.textContent = txt;
  }

  window.updateComponentData = function() {
    try {
      setStatus('JS: calcul…');

      var lines = [];
      var cbs = document.querySelectorAll('input.ac-enabled');

      cbs.forEach(function(cb) {
        if (!cb.checked) return;

        var m = cb.name.match(/line_(\\d+)_enabled/);
        if (!m) return;
        var i = m[1];

        var artEl = document.querySelector('input[name="line_' + i + '_key"]');
        var verEl = document.querySelector('select[name="line_' + i + '_version"]');

        var art = artEl ? artEl.value : '';
        var ver = verEl ? verEl.value : '';

        if (art && ver) lines.push(art + '=' + ver);
      });

      var value = lines.join('\\n');
      console.log('[COMPONENT] computed selection:\\n' + value);

      // ✅ ÉCRITURE DANS NOTRE PROPRE CHAMP CACHÉ
      var field = document.getElementById('COMPONENT_DATA');
      if (field) {
        field.value = value;
        field.dispatchEvent(new Event('input',  { bubbles: true }));
        field.dispatchEvent(new Event('change', { bubbles: true }));
        setStatus('JS: OK (' + lines.length + ' ligne(s))');
      } else {
        setStatus('JS: champ caché introuvable !');
      }
    } catch (e) {
      console.error('[COMPONENT] error', e);
      setStatus('JS: erreur (console)');
    }
  };

  setStatus('JS: chargé ✅');
  setTimeout(window.updateComponentData, 100);
})();
</script>

// --- CONFIG ---
def fixedInputs = [
  "bw-eai-bofi",
  "bw-eai-bofi-swift",
  "bw-eai-bofi-batch",
  "bw-eai-framework-ear-linux",
  "bw-eai-ftp",
  "bw-eai-http",
  "bw-eai-maestro",
  "bw-eai-market-data",
  "bw-eai-ref",
  "bw-eai-reports",
  "bw-eai-rgv",
  "bw-eai-monitoring"
]

// --- Helpers ---
def esc = { s ->
  if (s == null) return ""
  s.toString()
   .replace("&","&amp;")
   .replace("<","&lt;")
   .replace(">","&gt;")
   .replace("\"","&quot;")
   .replace("'","&#39;")
}

def fetchOptions = { String artifactOrKey ->
  def cmd = "curl -s -k https://src1ems02:9091/rest/livraison/getVersionList?art=${artifactOrKey}"
  def out = cmd.execute().text?.trim()
  def tokens = out ? out.tokenize(",").collect { it.trim() } : []
  if (tokens.isEmpty()) tokens = ["(aucune option)"]
  return tokens
}

def sb = new StringBuilder()

// --- HTML header ---
sb.append('''
<style>
.ac-wrap{ max-width: 980px; }
.ac-panel{
  border: 1px solid rgba(0,0,0,.12);
  border-radius: 6px;
  background: #fff;
  overflow: hidden;
}
.ac-header{
  padding: 10px 12px;
  background: rgba(0,0,0,.03);
  border-bottom: 1px solid rgba(0,0,0,.08);
  font-weight: 600;
}
.ac-table{ width: 100%; border-collapse: collapse; }
.ac-table th, .ac-table td{
  padding: 8px 12px;
  border-bottom: 1px solid rgba(0,0,0,.08);
  vertical-align: middle;
}
.ac-table th{
  font-weight: 600;
  color: rgba(0,0,0,.75);
  background: rgba(0,0,0,.02);
  text-align: left;
  white-space: nowrap;
}
.ac-table tr:hover td{ background: rgba(0,0,0,.015); }
.ac-input, .ac-select{
  width: 100%;
  box-sizing: border-box;
  padding: 6px 8px;
  border: 1px solid rgba(0,0,0,.2);
  border-radius: 4px;
  background: #fff;
  font-size: 13px;
  line-height: 18px;
}
.ac-input[readonly]{
  background: rgba(0,0,0,.03);
  color: rgba(0,0,0,.75);
}
.ac-check{
  display: inline-flex;
  align-items: center;
  gap: 8px;
  user-select: none;
  font-size: 13px;
}
.ac-muted{
  color: rgba(0,0,0,.6);
  font-size: 12px;
  margin-top: 8px;
}
.ac-col-art{ width: 44%; }
.ac-col-ver{ width: 40%; }
.ac-col-on { width: 16%; text-align: left; }
code{ background: rgba(0,0,0,.05); padding: 1px 4px; border-radius: 3px; }
.ac-badge{
  display:inline-block;
  padding:2px 6px;
  border-radius:10px;
  font-size:12px;
  background: rgba(0,0,0,.06);
  color: rgba(0,0,0,.75);
}
</style>

<div class="ac-wrap">
  <div class="ac-panel">
    <div class="ac-header">
      Sélection des versions par artifact
      <span id="js_status" class="ac-badge" style="margin-left:8px;">JS: en attente…</span>
    </div>
    <table class="ac-table" id="acTable">
      <thead>
        <tr>
          <th class="ac-col-art">Artifact</th>
          <th class="ac-col-ver">Version (API)</th>
          <th class="ac-col-on">Inclure</th>
        </tr>
      </thead>
      <tbody>
''')

// --- rows ---
fixedInputs.eachWithIndex { fixedValue, i ->
  def options = fetchOptions(fixedValue)

  def keyName = "line_${i}_key"
  def selName = "line_${i}_version"
  def chkName = "line_${i}_enabled"

  sb.append("<tr>")

  // 1) read-only artifact
  sb.append("<td><input class='ac-input' type='text' name='")
    .append(esc(keyName))
    .append("' value='")
    .append(esc(fixedValue))
    .append("' readonly /></td>")

  // 2) select version
  sb.append("<td><select class='ac-select' name='")
    .append(esc(selName))
    .append("' onchange='updateComponentData()'>")

  options.each { opt ->
    sb.append("<option value='")
      .append(esc(opt))
      .append("'>")
      .append(esc(opt))
      .append("</option>")
  }

  sb.append("</select></td>")

  // 3) checkbox include
  sb.append("<td class='ac-col-on'><label class='ac-check'>")
    .append("<input type='checkbox' class='ac-enabled' name='")
    .append(esc(chkName))
    .append("' value='true' onclick='updateComponentData()'/>")
    .append("</label></td>")

  sb.append("</tr>")
}

sb.append('''
      </tbody>
    </table>
  </div>

  <div class="ac-muted">
    Les lignes cochées sont écrites dans le paramètre Jenkins <code>COMPONENT_DATA</code> (format <code>artifact=version</code>, une par ligne).
  </div>
</div>

<script>
(function(){
  function findJenkinsComponentField() {
    // ✅ Le bon champ est celui dans le <form> Jenkins
    // (il peut y avoir plusieurs éléments name=COMPONENT_DATA, on prend celui dans form)
    var el = document.querySelector('form [name="COMPONENT_DATA"]');
    return el;
  }

  function setStatus(txt) {
    var s = document.getElementById('js_status');
    if (s) s.textContent = txt;
  }

  window.updateComponentData = function() {
    try {
      setStatus('JS: calcul…');

      var lines = [];
      var cbs = document.querySelectorAll('input.ac-enabled');

      cbs.forEach(function(cb) {
        if (!cb.checked) return;

        var m = cb.name.match(/line_(\\d+)_enabled/);
        if (!m) return;
        var i = m[1];

        var artEl = document.querySelector('input[name="line_' + i + '_key"]');
        var verEl = document.querySelector('select[name="line_' + i + '_version"]');

        var art = artEl ? artEl.value : '';
        var ver = verEl ? verEl.value : '';

        if (art && ver) lines.push(art + '=' + ver);
      });

      var value = lines.join('\\n');
      console.log('[COMPONENT] computed selection:\\n' + value);

      var field = findJenkinsComponentField();
      console.log('[COMPONENT] form COMPONENT_DATA field =', field);

      if (!field) {
        setStatus('JS: champ COMPONENT_DATA introuvable (retry)');
        // Active Choices peut charger le HTML avant le champ param -> retry
        setTimeout(window.updateComponentData, 300);
        return;
      }

      field.value = value;
      field.dispatchEvent(new Event('input',  { bubbles: true }));
      field.dispatchEvent(new Event('change', { bubbles: true }));

      setStatus('JS: OK (' + lines.length + ' ligne(s))');
    } catch (e) {
      console.error('[COMPONENT] updateComponentData error', e);
      setStatus('JS: erreur (console)');
    }
  };

  // init
  setStatus('JS: chargé ✅');
  setTimeout(window.updateComponentData, 0);
})();
</script>
''')

return sb.toString()
