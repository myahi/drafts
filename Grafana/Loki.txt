{
  "uid": "loki-camel-logs-all",
  "title": "Apache Camel - Logs (All levels)",
  "timezone": "browser",
  "schemaVersion": 38,
  "version": 1,
  "refresh": "10s",
  "time": {
    "from": "now-6h",
    "to": "now"
  },
  "templating": {
    "list": [
      {
        "type": "datasource",
        "name": "DS_LOKI",
        "label": "Loki datasource",
        "query": "loki",
        "current": {
          "text": "Loki",
          "value": "Loki"
        }
      },
      {
        "type": "query",
        "name": "app",
        "label": "app",
        "datasource": {
          "type": "loki",
          "uid": "${DS_LOKI}"
        },
        "refresh": 1,
        "query": "label_values(app)",
        "current": {
          "text": "eai-core",
          "value": "eai-core"
        }
      },
      {
        "type": "query",
        "name": "env",
        "label": "env",
        "datasource": {
          "type": "loki",
          "uid": "${DS_LOKI}"
        },
        "refresh": 1,
        "query": "label_values(env)",
        "current": {
          "text": "prod",
          "value": "prod"
        }
      },
      {
        "type": "textbox",
        "name": "contains",
        "label": "Text contains (optional)",
        "current": {
          "text": "",
          "value": ""
        },
        "description": "Optionnel: filtre texte libre (ex: routeId=core-send-mail). Laisse vide pour tout."
      }
    ]
  },
  "panels": [
    {
      "id": 1,
      "type": "logs",
      "title": "Camel logs (stream) - all levels",
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 12 },
      "datasource": { "type": "loki", "uid": "${DS_LOKI}" },
      "options": {
        "showTime": true,
        "showLabels": false,
        "showCommonLabels": false,
        "wrapLogMessage": true,
        "prettifyLogMessage": false,
        "enableLogDetails": true,
        "dedupStrategy": "none",
        "sortOrder": "Descending"
      },
      "targets": [
        {
          "refId": "A",
          "expr": "{app=\"$app\", env=\"$env\"} |= \"org.apache.camel\" ${contains:raw}",
          "queryType": "range"
        }
      ]
    },
    {
      "id": 2,
      "type": "timeseries",
      "title": "Logs per minute (Camel) - all levels",
      "gridPos": { "x": 0, "y": 12, "w": 12, "h": 8 },
      "datasource": { "type": "loki", "uid": "${DS_LOKI}" },
      "fieldConfig": {
        "defaults": { "unit": "short" },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
        "tooltip": { "mode": "multi", "sort": "none" }
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(count_over_time({app=\"$app\", env=\"$env\"} |= \"org.apache.camel\" ${contains:raw} [1m]))",
          "queryType": "range"
        }
      ]
    },
    {
      "id": 3,
      "type": "timeseries",
      "title": "Logs per 10s (Camel) - live-ish",
      "gridPos": { "x": 12, "y": 12, "w": 12, "h": 8 },
      "datasource": { "type": "loki", "uid": "${DS_LOKI}" },
      "fieldConfig": {
        "defaults": { "unit": "short" },
        "overrides": []
      },
      "options": {
        "legend": { "displayMode": "list", "placement": "bottom", "showLegend": true },
        "tooltip": { "mode": "multi", "sort": "none" }
      },
      "targets": [
        {
          "refId": "A",
          "expr": "sum(count_over_time({app=\"$app\", env=\"$env\"} |= \"org.apache.camel\" ${contains:raw} [10s]))",
          "queryType": "range"
        }
      ]
    },
    {
      "id": 4,
      "type": "table",
      "title": "Top log lines (approx) - last 15m",
      "gridPos": { "x": 0, "y": 20, "w": 24, "h": 9 },
      "datasource": { "type": "loki", "uid": "${DS_LOKI}" },
      "options": { "showHeader": true },
      "targets": [
        {
          "refId": "A",
          "expr": "topk(10, sum by (line) (count_over_time({app=\"$app\", env=\"$env\"} |= \"org.apache.camel\" ${contains:raw} | line_format \"{{.}}\" [15m])))",
          "queryType": "range"
        }
      ],
      "transformations": [
        {
          "id": "organize",
          "options": {
            "excludeByName": { "Time": true },
            "renameByName": { "Value": "count" }
          }
        }
      ]
    }
  ],
  "annotations": { "list": [] },
  "links": []
}



Bonne question üëç
Je te donne la m√©thode simple et propre, sans Kubernetes, Grafana + Loki sur la m√™me VM (ce que tu d√©crivais).


---

üß© Important d‚Äôabord : Loki ‚â† plugin Grafana

üëâ Loki ne ‚Äús‚Äôinstalle pas dans Grafana‚Äù
üëâ C‚Äôest un service √† part, que Grafana consomme comme datasource.

Donc il y a 3 √©tapes :

1. Installer Loki


2. (Optionnel mais recommand√©) Installer Promtail


3. D√©clarer Loki comme datasource dans Grafana




---

1Ô∏è‚É£ Installer Loki (sur la VM Grafana)

a) T√©l√©charger Loki

cd /opt
curl -LO https://github.com/grafana/loki/releases/latest/download/loki-linux-amd64
chmod +x loki-linux-amd64
mv loki-linux-amd64 loki


---

b) Config minimale Loki

Cr√©er /etc/loki/loki.yaml :

auth_enabled: false

server:
  http_listen_port: 3100

common:
  path_prefix: /var/lib/loki
  storage:
    filesystem:
      chunks_directory: /var/lib/loki/chunks
      rules_directory: /var/lib/loki/rules
  replication_factor: 1
  ring:
    kvstore:
      store: inmemory

schema_config:
  configs:
    - from: 2023-01-01
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

limits_config:
  retention_period: 168h   # 7 jours

Cr√©er les dossiers :

mkdir -p /var/lib/loki/{chunks,rules}


---

c) Lancer Loki

/opt/loki -config.file=/etc/loki/loki.yaml

Test :

curl http://localhost:3100/ready

üëâ doit r√©pondre ready


---

2Ô∏è‚É£ Installer Promtail (sur chaque VM applicative)

a) T√©l√©charger

curl -LO https://github.com/grafana/loki/releases/latest/download/promtail-linux-amd64
chmod +x promtail-linux-amd64
mv promtail-linux-amd64 promtail


---

b) Config minimale Promtail

/etc/promtail/promtail.yaml :

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: http://VM_GRAFANA:3100/loki/api/v1/push

scrape_configs:
  - job_name: spring-boot
    static_configs:
      - targets:
          - localhost
        labels:
          app: eai-core
          env: prod
          __path__: /var/log/app/*.log


---

c) Lancer Promtail

/opt/promtail -config.file=/etc/promtail/promtail.yaml


---

3Ô∏è‚É£ Ajouter Loki dans Grafana

a) UI Grafana

Settings ‚Üí Data sources

Add data source

Choisir Loki


b) Config

URL :

http://localhost:3100

Save & Test ‚Üí ‚úÖ



---

4Ô∏è‚É£ V√©rifier que √ßa marche

Dans Grafana ‚Üí Explore :

Datasource : Loki

Requ√™te :


{app="eai-core"}

üëâ tu dois voir les logs arriver.


---

üî• R√©sum√© ultra-court

Loki = service

Promtail = agent

Grafana = UI

1 port √† ouvrir : 3100 vers la VM Grafana

Pas de plugin √† installer



---

Tu veux aller plus loin ?

Je peux te fournir :

un service systemd pour Loki & Promtail

un logback-spring.xml JSON optimis√© Loki

une requ√™te LogQL pr√™te pour Camel

une alerte Grafana bas√©e sur logs ERROR


Dis-moi üëç


logging.level.root=WARN
logging.level.org.apache.camel=WARN
logging.level.fr.labanquepostale=INFO
