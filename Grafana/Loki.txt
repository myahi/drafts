Bonne question ğŸ‘
Je te donne la mÃ©thode simple et propre, sans Kubernetes, Grafana + Loki sur la mÃªme VM (ce que tu dÃ©crivais).


---

ğŸ§© Important dâ€™abord : Loki â‰  plugin Grafana

ğŸ‘‰ Loki ne â€œsâ€™installe pas dans Grafanaâ€
ğŸ‘‰ Câ€™est un service Ã  part, que Grafana consomme comme datasource.

Donc il y a 3 Ã©tapes :

1. Installer Loki


2. (Optionnel mais recommandÃ©) Installer Promtail


3. DÃ©clarer Loki comme datasource dans Grafana




---

1ï¸âƒ£ Installer Loki (sur la VM Grafana)

a) TÃ©lÃ©charger Loki

cd /opt
curl -LO https://github.com/grafana/loki/releases/latest/download/loki-linux-amd64
chmod +x loki-linux-amd64
mv loki-linux-amd64 loki


---

b) Config minimale Loki

CrÃ©er /etc/loki/loki.yaml :

auth_enabled: false

server:
  http_listen_port: 3100

common:
  path_prefix: /var/lib/loki
  storage:
    filesystem:
      chunks_directory: /var/lib/loki/chunks
      rules_directory: /var/lib/loki/rules
  replication_factor: 1
  ring:
    kvstore:
      store: inmemory

schema_config:
  configs:
    - from: 2023-01-01
      store: boltdb-shipper
      object_store: filesystem
      schema: v11
      index:
        prefix: index_
        period: 24h

limits_config:
  retention_period: 168h   # 7 jours

CrÃ©er les dossiers :

mkdir -p /var/lib/loki/{chunks,rules}


---

c) Lancer Loki

/opt/loki -config.file=/etc/loki/loki.yaml

Test :

curl http://localhost:3100/ready

ğŸ‘‰ doit rÃ©pondre ready


---

2ï¸âƒ£ Installer Promtail (sur chaque VM applicative)

a) TÃ©lÃ©charger

curl -LO https://github.com/grafana/loki/releases/latest/download/promtail-linux-amd64
chmod +x promtail-linux-amd64
mv promtail-linux-amd64 promtail


---

b) Config minimale Promtail

/etc/promtail/promtail.yaml :

server:
  http_listen_port: 9080
  grpc_listen_port: 0

positions:
  filename: /var/lib/promtail/positions.yaml

clients:
  - url: http://VM_GRAFANA:3100/loki/api/v1/push

scrape_configs:
  - job_name: spring-boot
    static_configs:
      - targets:
          - localhost
        labels:
          app: eai-core
          env: prod
          __path__: /var/log/app/*.log


---

c) Lancer Promtail

/opt/promtail -config.file=/etc/promtail/promtail.yaml


---

3ï¸âƒ£ Ajouter Loki dans Grafana

a) UI Grafana

Settings â†’ Data sources

Add data source

Choisir Loki


b) Config

URL :

http://localhost:3100

Save & Test â†’ âœ…



---

4ï¸âƒ£ VÃ©rifier que Ã§a marche

Dans Grafana â†’ Explore :

Datasource : Loki

RequÃªte :


{app="eai-core"}

ğŸ‘‰ tu dois voir les logs arriver.


---

ğŸ”¥ RÃ©sumÃ© ultra-court

Loki = service

Promtail = agent

Grafana = UI

1 port Ã  ouvrir : 3100 vers la VM Grafana

Pas de plugin Ã  installer



---

Tu veux aller plus loin ?

Je peux te fournir :

un service systemd pour Loki & Promtail

un logback-spring.xml JSON optimisÃ© Loki

une requÃªte LogQL prÃªte pour Camel

une alerte Grafana basÃ©e sur logs ERROR


Dis-moi ğŸ‘


logging.level.root=WARN
logging.level.org.apache.camel=WARN
logging.level.fr.labanquepostale=INFO
