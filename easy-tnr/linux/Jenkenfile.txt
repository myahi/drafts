pipeline {
agent any
options { timestamps(); disableConcurrentBuilds() }

  environment {
    APP_HOST = 'sdv4eai02'
    APP_DATA_DIR = '/serveur_apps/easy-tnr/data/'
    APP_SCRIPT = '/serveur_apps/easy-tnr/scripts/start_batch.sh'
    REPO_URL = 'https://gitlab.pop.sf.intra.laposte.fr/bfi-mar-tpma/eai-marches/sources-eai/tnr-data.git'
    RSYNC_OPTS = '-q -c aes128-ctr -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=5'
    SSH_OPTS = '-q -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=5'
	GIT_CRED = 'usr_gitlab_eai'
  }

  stages {

    stage('Checkout TNR data from repository') {
      steps {
	  script {
          try {
            def branch = 'develop'
            def repoUrl = "${env.REPO_URL}"
            echo "Checkout repo=${repoUrl} branch=${branch}"
            checkout([
              $class: 'GitSCM',
              branches: [[name: branch]],
              userRemoteConfigs: [[
                url: repoUrl,
                credentialsId: env.GIT_CRED
              ]]
            ])
          } catch (e) {
            echo "Erreur pendant le stage: Checkout TNR data from repository"
            echo e.toString()
            throw e
          }
        }
      }
    }
	stage('Sync to sdv4eai02') {
      steps {
	  script {
	  try {
          sh """
            rsync -a --delete \
              -e "ssh ${RSYNC_OPTS}" \
              ./ \
              ${env.EAI_SSH_USER}@${APP_HOST}:${APP_DATA_DIR}
          """
		}
		catch (e) {
            echo "Erreur pendant le stage: Sync to sdv4eai02"
            echo e.toString()
            throw e
          }
      }
	  }
    }
	stage('Run BLOOMBERG_BOND_TOMS') {
      when { expression { return params.BLOOMBERG_BOND_TOMS } }
      steps {
          sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
              /serveur_apps/easy-tnr/scripts/start_batch.sh \
              DEVEAI \
              BLOOMBERG_BOND_TOMS \
              MAESTRO/BLOOMBERG_TO_CALYPSO/BOND_TOMS \
              -DMaestroDBURL=${params.MaestroDBURL} \
              -DMaestroDBUser=${params.MaestroDBUser} \
              -DMaestroDBPWD=${params.MaestroDBPWD} \
              -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
              -DTNRFolder=${params.TNRFolder} \
              -DmaestroProjectName=${params.maestroProjectName} \
              -DFTPHost=${params.FTPHost} \
              -DFTPUser=${params.FTPUser} \
              -DFTPPwd=${params.FTPPwd}
            "
          """
      }
  }
  }
}
