// On déclare la map tout en haut pour qu'elle soit accessible partout
def stageResults = [:]

pipeline {
  agent any
  options { timestamps(); disableConcurrentBuilds() }

  environment {
    APP_HOST = 'sdv4eai02'
    APP_DATA_DIR = '/serveur_apps/easy-tnr/data/'
    APP_SCRIPT = '/serveur_apps/easy-tnr/scripts/start_batch.sh'
    REPO_URL = 'https://gitlab.pop.sf.intra.laposte.fr/bfi-mar-tpma/eai-marches/sources-eai/tnr-data.git'
    RSYNC_OPTS = '-q -c aes128-ctr -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=5'
    SSH_OPTS = '-q -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=5'
    GIT_CRED = 'usr_gitlab_eai'
  }

  stages {

    stage('Checkout TNR data') {
      steps {
        script {
          try {
            deleteDir() 
            checkout([$class: 'GitSCM', branches: [[name: 'develop']], userRemoteConfigs: [[url: env.REPO_URL, credentialsId: env.GIT_CRED]]])
          } catch (e) {
            echo "Erreur checkout : ${e.toString()}"
            throw e
          }
        }
      }
    }

    stage('Sync to sdv4eai02') {
      steps {
        script {
          try {
            withEnv(['LANG=C.UTF-8','LC_ALL=C.UTF-8']) {
              sh "ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} 'rm -rf ${APP_DATA_DIR}/* && mkdir -p ${APP_DATA_DIR}'"
              // Correction iconv pour gérer les accents é -> \351 lors du transfert
              sh """
                rsync -a --delete --checksum --iconv=ISO-8859-1,UTF-8 \
                  --rsync-path="LANG=C.UTF-8 LC_ALL=C.UTF-8 rsync" \
                  -e "ssh ${RSYNC_OPTS}" ./ ${env.EAI_SSH_USER}@${APP_HOST}:${APP_DATA_DIR}
              """
            }
          } catch (e) {
            echo "Erreur Sync : ${e.toString()}"
            throw e
          }
        }
      }
    }

    // --- STAGES TNR AVEC SAUVEGARDE DU STATUT ---

    stage('Run MAESTRO_BLOOMBERG_REPO') {
      when { expression { return params.MAESTRO_BLOOMBERG_REPO } }
      steps {
        script {
          catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
            runTnrStage('MAESTRO_BLOOMBERG_REPO', 'MAESTRO/BLOOMBERG_TO_CALYPSO/REPO')
            stageResults['Bloomberg Repo'] = "Succès ✅"
          }
          if (!stageResults['Bloomberg Repo']) { stageResults['Bloomberg Repo'] = "Échec ❌" }
        }
      }
    }

    stage('Run MAESTRO_BLOOMBERG_BOND') {
      when { expression { return params.MAESTRO_BLOOMBERG_BOND } }
      steps {
        script {
          catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
            runTnrStage('MAESTRO_BLOOMBERG_BOND', 'MAESTRO/BLOOMBERG_TO_CALYPSO/BOND')
            stageResults['Bloomberg Bond'] = "Succès ✅"
          }
          if (!stageResults['Bloomberg Bond']) { stageResults['Bloomberg Bond'] = "Échec ❌" }
        }
      }
    }
	
	stage('Run BLOOMBERG_BOND_TOMS') {
      when { expression { return params.BLOOMBERG_BOND_TOMS } }
      steps {
        script {
          catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
            runTnrStage('BLOOMBERG_BOND_TOMS', 'MAESTRO/BLOOMBERG_TO_CALYPSO/BOND_TOMS')
            stageResults['Bloomberg TOMS Bond'] = "Succès ✅"
          }
          if (!stageResults['Bloomberg TOMS Bond']) { stageResults['Bloomberg TOMS Bond'] = "Échec ❌" }
        }
      }
    }

    stage('Run MAESTRO_GLMX_REPO') {
      when { expression { return params.MAESTRO_GLMX_REPO } }
      steps {
        script {
          catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
            runTnrStage('MAESTRO_GLMX_REPO', 'MAESTRO/GLMX_TO_CALYPSO/REPO')
            stageResults['GLMX Repo'] = "Succès ✅"
          }
          if (!stageResults['GLMX Repo']) { stageResults['GLMX Repo'] = "Échec ❌" }
        }
      }
    }

    stage('Run MAESTRO_CME_REPO') {
      when { expression { return params.MAESTRO_CME_REPO } }
      steps {
        script {
          catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
            runTnrStage('MAESTRO_CME_REPO', 'MAESTRO/CME_TO_CALYPSO/REPO')
            stageResults['CME (BTEC) Repo'] = "Succès ✅"
          }
          if (!stageResults['CME (BTEC) Repo']) { stageResults['CME (BTEC) Repo'] = "Échec ❌" }
        }
      }
    }

    stage('Run MAESTRO_360T_FX_FWD') {
      when { expression { return params.MAESTRO_360T_FX_FWD } }
      steps {
        script {
          catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
            runTnrStage('MAESTRO_360T_FX_FWD', 'MAESTRO/360T_TO_CALYPSO/FX_FWD')
            stageResults['360T FX Forwad'] = "Succès ✅"
          }
          if (!stageResults['360T FX Forwad']) { stageResults['360T FX Forwad'] = "Échec ❌" }
        }
      }
    }
	stage('Run MAESTRO_360T_FX_SPOT') {
      when { expression { return params.MAESTRO_360T_FX_SPOT } }
      steps {
        script {
          catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
            runTnrStage('MAESTRO_360T_FX_SPOT', 'MAESTRO/360T_TO_CALYPSO/FX_SPOT')
            stageResults['360T FX Spot'] = "Succès ✅"
          }
          if (!stageResults['360T FX Spot']) { stageResults['360T FX Spot'] = "Échec ❌" }
        }
      }
    }
	stage('Run MAESTRO_360T_FX_SWAP') {
      when { expression { return params.MAESTRO_360T_FX_SWAP } }
      steps {
        script {
          catchError(buildResult: 'FAILURE', stageResult: 'FAILURE') {
            runTnrStage('MAESTRO_360T_FX_SWAP', 'MAESTRO/360T_TO_CALYPSO/FX_SWAP')
            stageResults['360T FX Swap'] = "Succès ✅"
          }
          if (!stageResults['360T FX Swap']) { stageResults['360T FX Swap'] = "Échec ❌" }
        }
      }
    }

    // --- STAGE FINAL : EMAIL RÉCAPITULATIF ---

stage('Email Recap Report') {
  when { expression { return params.SEND_EMAIL_REPORT } }
  steps {
    script {
      def resultGlobal = currentBuild.currentResult ?: 'SUCCESS'
      def colorTheme = (resultGlobal == 'SUCCESS') ? "#28a745" : "#d73a49"
      def tableRows = ""
      
      stageResults.each { name, status ->
        def rowColor = status.contains("Succès") ? "#f8fff9" : "#fff8f8"
        def statusColor = status.contains("Succès") ? "#28a745" : "#d73a49"
        tableRows += """
          <tr style="background-color: ${rowColor}; font-family: Calibri, sans-serif;">
            <td style="padding: 5px; border: 1px solid #ddd; color: #333;">${name}</td>
            <td style="padding: 5px; border: 1px solid #ddd; text-align: center; color: ${statusColor};">${status}</td>
          </tr>
        """
      }

      def mailBody = """
        <html>
        <body style="font-family: Calibri, sans-serif; padding: 20px; color: #333;">
          <div style="max-width: 600px; margin: auto; border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
            
            <div style="background-color: ${colorTheme}; padding: 15px; text-align: center; color: #ffffff;">
              <h2 style="margin: 0; font-family: Calibri, sans-serif; font-weight: normal; font-size: 22px;">Rapport : ${env.JOB_NAME}</h2>
              <p style="margin: 5px 0 0 0; font-size: 16px;">Statut Final : ${resultGlobal}</p>
            </div>

            <div style="padding: 20px; background-color: #ffffff;">
              <p style="font-size: 15px; font-family: Calibri, sans-serif;">Récapitulatif pour le build <strong>#${env.BUILD_NUMBER}</strong> :</p>
              
              <table style="width: 100%; border-collapse: collapse; margin-bottom: 25px; font-family: Calibri, sans-serif;">
                <thead>
                  <tr style="background-color: #f8f8f8; color: #666;">
                    <th style="padding: 5px; border: 1px solid #eee; text-align: left; font-weight: normal;">Flux Applicatif</th>
                    <th style="padding: 15px; border: 1px solid #eee; text-align: center; font-weight: normal;">Résultat</th>
                  </tr>
                </thead>
                <tbody>${tableRows}</tbody>
              </table>

              <div style="text-align: center; margin: 10px 0;">
                <a href="${env.BUILD_URL}console" 
                   style="background-color: #007bff; 
                          border: 12px solid #007bff; 
                          padding: 0px 20px; 
                          color: #ffffff; 
                          text-decoration: none; 
                          font-size: 14px; 
                          font-family: Calibri, sans-serif; 
                          border-radius: 10px; 
                          display: inline-block;
						  margin-bottom:10px;
                          text-underline-color: #007bff;">
                   Consulter les logs
                </a>
              </div>
            </div>
          </div>
        </body>
        </html>
      """

      emailext to: 'mohamed.yahi-prestataire@labanquepostale.fr',
               subject: "TNR [${env.JOB_NAME}] - Build #${env.BUILD_NUMBER}",
               body: mailBody,
               mimeType: 'text/html'
    }
  }
}

  }
}

def runTnrStage(stageName, scenarioPath) {
    def logFile = "output_${stageName}.log"
    try {
        sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
                ${env.APP_SCRIPT} DEVEAI ${stageName} '${scenarioPath}' \
                -Dfile.encoding=UTF-8 \
                -Dsun.jnu.encoding=UTF-8 \
                -DMaestroDBURL=${params.MaestroDBURL} \
                -DMaestroDBUser=${params.MaestroDBUser} \
                -DMaestroDBPWD=${params.MaestroDBPWD} \
                -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
                -DTNRFolder=${params.TNRFolder} \
                -DmaestroProjectName=${params.maestroProjectName} \
                -DFTPHost=${params.FTPHost} \
                -DFTPUser=${params.FTPUser} \
                -DFTPPwd=${params.FTPPwd}
            " | tee ${logFile}

            if grep -Ei "failure|ERROR|Difference found" ${logFile}; then
                echo "Anomalie détectée dans le fichier log."
                exit 1
            fi
        """
    } catch (Exception e) {
        error "échec détecté dans les logs pour ${stageName}"
    } finally {
        sh "rm -f ${logFile}"
    }
}
