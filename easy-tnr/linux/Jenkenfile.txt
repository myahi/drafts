pipeline {
agent any
options { timestamps(); disableConcurrentBuilds() }

  environment {
    APP_HOST = 'sdv4eai02'
    APP_DATA_DIR = '/serveur_apps/easy-tnr/data/'
    APP_SCRIPT = '/serveur_apps/easy-tnr/scripts/start_batch.sh'
    REPO_URL = 'https://gitlab.pop.sf.intra.laposte.fr/bfi-mar-tpma/eai-marches/sources-eai/tnr-data.git'
    RSYNC_OPTS = '-q -c aes128-ctr -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=5'
    SSH_OPTS = '-q -o BatchMode=yes -o StrictHostKeyChecking=no -o ConnectTimeout=5'
	GIT_CRED = 'usr_gitlab_eai'
  }

  stages {

    stage('Checkout TNR data from repository') {
      steps {
	  script {
          try {
            def branch = 'develop'
            def repoUrl = "${env.REPO_URL}"
            echo "Checkout repo=${repoUrl} branch=${branch}"
            checkout([
              $class: 'GitSCM',
              branches: [[name: branch]],
              userRemoteConfigs: [[
                url: repoUrl,
                credentialsId: env.GIT_CRED
              ]]
            ])
          } catch (e) {
            echo "Erreur pendant le stage: Checkout TNR data from repository"
            echo e.toString()
            throw e
          }
        }
      }
    }
	stage('Sync to sdv4eai02') {
      steps {
	  script {
	  try {
          sh """
            rsync -a --delete \
              -e "ssh ${RSYNC_OPTS}" \
              ./ \
              ${env.EAI_SSH_USER}@${APP_HOST}:${APP_DATA_DIR}
          """
		}
		catch (e) {
            echo "Erreur pendant le stage: Sync to sdv4eai02"
            echo e.toString()
            throw e
          }
      }
	  }
    }
	stage('Run MAESTRO_BLOOMBERG_REPO') {
      when { expression { return params.MAESTRO_BLOOMBERG_REPO } }
      steps {
          sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
              /serveur_apps/easy-tnr/scripts/start_batch.sh \
              DEVEAI \
              MAESTRO_BLOOMBERG_REPO \
			  MAESTRO/BLOOMBERG_TO_CALYPSO/REPO \
              -DMaestroDBURL=${params.MaestroDBURL} \
              -DMaestroDBUser=${params.MaestroDBUser} \
              -DMaestroDBPWD=${params.MaestroDBPWD} \
              -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
              -DTNRFolder=${params.TNRFolder} \
              -DmaestroProjectName=${params.maestroProjectName} \
              -DFTPHost=${params.FTPHost} \
              -DFTPUser=${params.FTPUser} \
              -DFTPPwd=${params.FTPPwd}
            "
          """
      }
  }
  stage('Run BLOOMBERG_BOND_TOMS') {
      when { expression { return params.BLOOMBERG_BOND_TOMS } }
      steps {
          sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
              /serveur_apps/easy-tnr/scripts/start_batch.sh \
              DEVEAI \
              BLOOMBERG_BOND_TOMS \
              MAESTRO/BLOOMBERG_TO_CALYPSO/BOND_TOMS \
              -DMaestroDBURL=${params.MaestroDBURL} \
              -DMaestroDBUser=${params.MaestroDBUser} \
              -DMaestroDBPWD=${params.MaestroDBPWD} \
              -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
              -DTNRFolder=${params.TNRFolder} \
              -DmaestroProjectName=${params.maestroProjectName} \
              -DFTPHost=${params.FTPHost} \
              -DFTPUser=${params.FTPUser} \
              -DFTPPwd=${params.FTPPwd}
            "
          """
      }
  }
  stage('Run MAESTRO_BLOOMBERG_BOND') {
      when { expression { return params.MAESTRO_BLOOMBERG_BOND } }
      steps {
          sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
              /serveur_apps/easy-tnr/scripts/start_batch.sh \
              DEVEAI \
              MAESTRO_BLOOMBERG_BOND \
              MAESTRO/BLOOMBERG_TO_CALYPSO/BOND \
              -DMaestroDBURL=${params.MaestroDBURL} \
              -DMaestroDBUser=${params.MaestroDBUser} \
              -DMaestroDBPWD=${params.MaestroDBPWD} \
              -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
              -DTNRFolder=${params.TNRFolder} \
              -DmaestroProjectName=${params.maestroProjectName} \
              -DFTPHost=${params.FTPHost} \
              -DFTPUser=${params.FTPUser} \
              -DFTPPwd=${params.FTPPwd}
            "
          """
      }
  }
    stage('Run MAESTRO_GLMX_REPO') {
      when { expression { return params.MAESTRO_GLMX_REPO } }
      steps {
          sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
              /serveur_apps/easy-tnr/scripts/start_batch.sh \
              DEVEAI \
              MAESTRO_GLMX_REPO \
              MAESTRO/GLMX_TO_CALYPSO/REPO \
              -DMaestroDBURL=${params.MaestroDBURL} \
              -DMaestroDBUser=${params.MaestroDBUser} \
              -DMaestroDBPWD=${params.MaestroDBPWD} \
              -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
              -DTNRFolder=${params.TNRFolder} \
              -DmaestroProjectName=${params.maestroProjectName} \
              -DFTPHost=${params.FTPHost} \
              -DFTPUser=${params.FTPUser} \
              -DFTPPwd=${params.FTPPwd}
            "
          """
      }
  }
  stage('Run MAESTRO_CME_REPO') {
      when { expression { return params.MAESTRO_CME_REPO } }
      steps {
          sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
              /serveur_apps/easy-tnr/scripts/start_batch.sh \
              DEVEAI \
              MAESTRO_CME_REPO \
              MAESTRO/CME_TO_CALYPSO/REPO \
              -DMaestroDBURL=${params.MaestroDBURL} \
              -DMaestroDBUser=${params.MaestroDBUser} \
              -DMaestroDBPWD=${params.MaestroDBPWD} \
              -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
              -DTNRFolder=${params.TNRFolder} \
              -DmaestroProjectName=${params.maestroProjectName} \
              -DFTPHost=${params.FTPHost} \
              -DFTPUser=${params.FTPUser} \
              -DFTPPwd=${params.FTPPwd}
            "
          """
      }
  }
  stage('Run MAESTRO_360T_FX_FWD') {
      when { expression { return params.MAESTRO_360T_FX_FWD } }
      steps {
          sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
              /serveur_apps/easy-tnr/scripts/start_batch.sh \
              DEVEAI \
              MAESTRO_360T_FX_FWD \
              MAESTRO/360T_TO_CALYPSO/FX_FWD \
              -DMaestroDBURL=${params.MaestroDBURL} \
              -DMaestroDBUser=${params.MaestroDBUser} \
              -DMaestroDBPWD=${params.MaestroDBPWD} \
              -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
              -DTNRFolder=${params.TNRFolder} \
              -DmaestroProjectName=${params.maestroProjectName} \
              -DFTPHost=${params.FTPHost} \
              -DFTPUser=${params.FTPUser} \
              -DFTPPwd=${params.FTPPwd}
            "
          """
      }
  }
  stage('Run MAESTRO_360T_FX_SPOT') {
      when { expression { return params.MAESTRO_360T_FX_SPOT } }
      steps {
          sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
              /serveur_apps/easy-tnr/scripts/start_batch.sh \
              DEVEAI \
              MAESTRO_360T_FX_SPOT \
              MAESTRO/360T_TO_CALYPSO/FX_SPOT \
              -DMaestroDBURL=${params.MaestroDBURL} \
              -DMaestroDBUser=${params.MaestroDBUser} \
              -DMaestroDBPWD=${params.MaestroDBPWD} \
              -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
              -DTNRFolder=${params.TNRFolder} \
              -DmaestroProjectName=${params.maestroProjectName} \
              -DFTPHost=${params.FTPHost} \
              -DFTPUser=${params.FTPUser} \
              -DFTPPwd=${params.FTPPwd}
            "
          """
      }
  }
  stage('Run MAESTRO_360T_FX_SWAP') {
      when { expression { return params.MAESTRO_360T_FX_SWAP } }
      steps {
          sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
              /serveur_apps/easy-tnr/scripts/start_batch.sh \
              DEVEAI \
              MAESTRO_360T_FX_SWAP \
              MAESTRO/360T_TO_CALYPSO/FX_SWAP \
              -DMaestroDBURL=${params.MaestroDBURL} \
              -DMaestroDBUser=${params.MaestroDBUser} \
              -DMaestroDBPWD=${params.MaestroDBPWD} \
              -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
              -DTNRFolder=${params.TNRFolder} \
              -DmaestroProjectName=${params.maestroProjectName} \
              -DFTPHost=${params.FTPHost} \
              -DFTPUser=${params.FTPUser} \
              -DFTPPwd=${params.FTPPwd}
            "
          """
      }
  }
  stage('Run MAESTRO_SFIL') {
      when { expression { return params.MAESTRO_SFIL } }
      steps {
          sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "
              /serveur_apps/easy-tnr/scripts/start_batch.sh \
              DEVEAI \
              MAESTRO_SFIL \
              MAESTRO/SFIL_TO_CALYPSO \
              -DMaestroDBURL=${params.MaestroDBURL} \
              -DMaestroDBUser=${params.MaestroDBUser} \
              -DMaestroDBPWD=${params.MaestroDBPWD} \
              -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
              -DTNRFolder=${params.TNRFolder} \
              -DmaestroProjectName=${params.maestroProjectName} \
              -DFTPHost=${params.FTPHost} \
              -DFTPUser=${params.FTPUser} \
              -DFTPPwd=${params.FTPPwd}
            "
          """
      }
  }
  }
}
