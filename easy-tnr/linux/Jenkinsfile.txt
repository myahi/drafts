pipeline {
  agent { label 'linux' } // node/agent Linux sur sgl4shn04

  options {
    timestamps()
    ansiColor('xterm')
  }

  parameters {
    string(name: 'ENV_NAME', defaultValue: 'DEVEAI', description: 'Nom env EasyTNR')
    booleanParam(name: 'BLOOMBERG_BOND_TOMS', defaultValue: true, description: 'Lancer périmètre BLOOMBERG_BOND_TOMS')

    string(name: 'MaestroDBURL',  defaultValue: 'jdbc:oracle:thin:@SDV4EAI01.marches.intra.laposte.fr:1521/dv1maes1')
    string(name: 'MaestroDBUser', defaultValue: 'MAESTRO')
    password(name: 'MaestroDBPWD', defaultValue: '', description: 'Mot de passe Oracle (masqué)')

    string(name: 'EAIScenarioBasePath', defaultValue: '/serveur_apps/easy-tnr/data/eai/Differential')
    string(name: 'TNRFolder', defaultValue: '/sdv4eai02/serveur_apps_rw/TNR/')
    string(name: 'maestroProjectName', defaultValue: 'MAESTRO-TNR')

    string(name: 'FTPHost', defaultValue: 'sdv4eai02')
    string(name: 'FTPUser', defaultValue: 'usr_svc_eai_qlf')
    password(name: 'FTPPwd', defaultValue: '', description: 'Mot de passe FTP (masqué)')
  }

  environment {
    APP_HOST = 'sdv4eai02'
    APP_USER = 'user' // TODO: mets le user SSH réel
    APP_DATA_DIR = '/serveur_apps/easy-tnr/data/eai/'
    APP_SCRIPT = '/serveur_apps/easy-tnr/scripts/start_batch.sh'
    // Repo Git
    REPO_URL = 'https://gitlab.pop.sf.intra.laposte.fr/bfi-mar-tpma/eai-marches/sources-eai/tnr-data.git'
  }

  stages {

    stage('Checkout tnr-data') {
      steps {
        // Si ton Jenkins a accès au repo sans creds, remplace par: sh "git clone ..."
        checkout([
          $class: 'GitSCM',
          branches: [[name: '*/main']],   // adapte si besoin
          userRemoteConfigs: [[
            url: env.REPO_URL,
            credentialsId: 'gitlab-tnr-data' // TODO: ton cred Jenkins (ou supprime la ligne si pas nécessaire)
          ]]
        ])
      }
    }

    stage('Sync to sdv4eai02') {
      steps {
        sshagent(credentials: ['ssh-sdv4eai02']) {
          sh '''
            set -euo pipefail
            rsync -az --delete \
              -e "ssh -o StrictHostKeyChecking=no" \
              ./ \
              ${APP_USER}@${APP_HOST}:${APP_DATA_DIR}
          '''
        }
      }
    }

    stage('Run TNR batch (BLOOMBERG_BOND_TOMS)') {
      when { expression { return params.BLOOMBERG_BOND_TOMS } }
      steps {
        sshagent(credentials: ['ssh-sdv4eai02']) {
          sh '''
            set -euo pipefail

            # scénario conditionnel
            SCENARIOS="MAESTRO/BLOOMBERG_TO_CALYPSO/BOND_TOMS"
            BATCH_NAME="BLOOMBERG_BOND_TOMS"

            # IMPORTANT: ne pas echo les mots de passe
            ssh -o StrictHostKeyChecking=no ${APP_USER}@${APP_HOST} "bash -lc '
              ${APP_SCRIPT} \
                \"${ENV_NAME}\" \
                \"${BATCH_NAME}\" \
                \"${SCENARIOS}\" \
                -DMaestroDBURL=\"${MaestroDBURL}\" \
                -DMaestroDBUser=\"${MaestroDBUser}\" \
                -DMaestroDBPWD=\"${MaestroDBPWD}\" \
                -DEAIScenarioBasePath=\"${EAIScenarioBasePath}\" \
                -DTNRFolder=\"${TNRFolder}\" \
                -DmaestroProjectName=\"${maestroProjectName}\" \
                -DFTPHost=\"${FTPHost}\" \
                -DFTPUser=\"${FTPUser}\" \
                -DFTPPwd=\"${FTPPwd}\"
            '"
          '''
        }
      }
    }
  }

  post {
    always {
      // optionnel : récupérer des logs/rapports depuis sdv4eai02 si tu as un répertoire stable
      echo "Pipeline terminé."
    }
  }
}
