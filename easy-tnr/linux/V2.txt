def runTnrStage(stageName, scenarioPath) {
    def logFile = "output_${stageName}.log"
    try {
        sh """
            ssh ${SSH_OPTS} ${env.EAI_SSH_USER}@${APP_HOST} "export LANG=en_US.UTF-8; export LC_ALL=en_US.UTF-8; ${env.APP_SCRIPT} DEVEAI ${stageName} '${scenarioPath}' \
                -DMaestroDBURL=${params.MaestroDBURL} \
                -DMaestroDBUser=${params.MaestroDBUser} \
                -DMaestroDBPWD=${params.MaestroDBPWD} \
                -DEAIScenarioBasePath=${params.EAIScenarioBasePath} \
                -DTNRFolder=${params.TNRFolder} \
                -DmaestroProjectName=${params.maestroProjectName} \
                -DFTPHost=${params.FTPHost} \
                -DFTPUser=${params.FTPUser} \
                -DFTPPwd=${params.FTPPwd}
            " | tee ${logFile}

            if grep -Ei "failure|ERROR|Difference found" ${logFile}; then
                echo "Anomalie détectée dans le fichier log."
                exit 1
            fi
        """
    } catch (Exception e) {
        error "échec détecté dans les logs pour ${stageName}"
    } finally {
        sh "rm -f ${logFile}"
    }
}
