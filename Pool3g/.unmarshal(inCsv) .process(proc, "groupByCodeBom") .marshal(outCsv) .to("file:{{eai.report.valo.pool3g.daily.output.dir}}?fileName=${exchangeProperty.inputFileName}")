.unmarshal(inCsv)
.process(proc, "groupByCodeBom")
.marshal(outCsv)
.to("file:{{eai.report.valo.pool3g.daily.output.dir}}?fileName=${exchangeProperty.inputFileName}")

public void groupByCodeBom(Exchange exchange) {

    List<CalypsoMarginCall> rows =
        exchange.getIn().getBody(List.class);

    Map<String, SfdhMarginCallLine> map = new LinkedHashMap<>();

    for (CalypsoMarginCall in : rows) {

        in.computeTyped();

        SfdhMarginCallLine out = map(in); // ton map existant

        map.merge(out.getCodeBom(), out, (a, b) -> {
            a.nominalValue = a.nominalValue.add(b.nominalValue);
            a.nominalEuroValue = a.nominalEuroValue.add(b.nominalEuroValue);
            return a;
        });
    }

    // format final pour CSV
    map.values().forEach(line -> {
        line.setNominal(formatWithComma(line.nominalValue));
        line.setNominalEuro(formatWithComma(line.nominalEuroValue));
    });

    exchange.getIn().setBody(new ArrayList<>(map.values()));
}
